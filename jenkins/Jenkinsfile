pipeline {
  agent any

  environment {
    REGISTRY       = 'matt013'   // ðŸ”‘ Replace with your DockerHub username if different
    FRONTEND_IMAGE = "${REGISTRY}/frontend:latest"
    BACKEND_IMAGE  = "${REGISTRY}/backend:latest"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Frontend Test & Lint') {
      agent {
        kubernetes {
          yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: node
    image: node:18
    command: ["cat"]
    tty: true
"""
        }
      }
      steps {
        container('node') {
          dir('frontend') {
            sh '''
              set -euo pipefail
              echo "ðŸ“¦ Installing frontend dependencies..."
              npm ci

              echo "ðŸ” Running lint..."
              npm run lint || echo "lint returned non-zero (continuing)"

              echo "ðŸ§ª Running frontend tests..."
              npm test || echo "âš ï¸ No frontend tests found or tests failed (continuing)"
            '''
          }
        }
      }
    }

    stage('Backend Test & Lint') {
      agent {
        kubernetes {
          yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: python
    image: python:3.10
    command: ["cat"]
    tty: true
"""
        }
      }
      steps {
        container('python') {
          dir('backend') {
            sh '''
              set -euo pipefail
              echo "ðŸ“¦ Installing backend dependencies..."
              pip install --no-cache-dir -r requirements.txt

              echo "ðŸ” Running flake8..."
              flake8 . || echo "âš ï¸ Lint warnings found"

              echo "ðŸ§ª Running backend tests..."
              pytest || echo "âš ï¸ No backend tests found or tests failed (continuing)"
            '''
          }
        }
      }
    }

    stage('Build & Push Images') {
      agent {
        kubernetes {
          yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    # keep container alive with cat (kaniko image includes cat)
    command:
      - "cat"
    tty: true
    volumeMounts:
    - name: kaniko-docker-config
      mountPath: /kaniko/.docker/
  volumes:
  - name: kaniko-docker-config
    emptyDir: {}
"""
        }
      }
      steps {
        container('kaniko') {
          withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
            sh '''
              set -euo pipefail

              echo "ðŸ”‘ Configuring DockerHub authentication for Kaniko..."
              mkdir -p /kaniko/.docker
              cat > /kaniko/.docker/config.json <<EOF
{"auths":{"https://index.docker.io/v1/":{"username":"$DOCKER_USER","password":"$DOCKER_PASS"}}}
EOF
              chmod 600 /kaniko/.docker/config.json
              echo "âœ… Auth written to /kaniko/.docker/config.json"

              echo "â„¹ï¸ Workspace: $(pwd)"
              echo "ðŸš€ Building and pushing frontend image: $FRONTEND_IMAGE"
              /kaniko/executor \
                --dockerfile=frontend/Dockerfile \
                --context=dir://$(pwd)/frontend \
                --destination=$FRONTEND_IMAGE \
                --cache=true \
                --verbosity=info

              echo "ðŸš€ Building and pushing backend image: $BACKEND_IMAGE"
              /kaniko/executor \
                --dockerfile=backend/Dockerfile \
                --context=dir://$(pwd)/backend \
                --destination=$BACKEND_IMAGE \
                --cache=true \
                --verbosity=info

              echo "âœ… Finished building & pushing images"
            '''
          }
        }
      }
    }

    stage('Deploy to Kubernetes') {
      /* IMPORTANT: this stage runs on a node labeled 'k8s-agent'. Make sure you have a node/pod labeled 'k8s-agent' with kubectl and kubeconfig access to your target cluster. */
      agent { label 'k8s-agent' }
      steps {
        sh '''
          set -euo pipefail
          echo "ðŸš€ Deploying manifests to Kubernetes..."
          kubectl apply -f k8s/
          echo "âœ… Deploy step finished"
        '''
      }
    }
  }

  post {
    always {
      echo "Pipeline finished. Check above logs for details."
    }
    failure {
      echo "Pipeline failed â€” examine stage logs for errors."
    }
  }
}
