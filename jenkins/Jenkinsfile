pipeline {
  agent any

  environment {
    REGISTRY       = 'matt013'   // ğŸ”‘ DockerHub username
    FRONTEND_IMAGE = "${REGISTRY}/frontend:latest"
    BACKEND_IMAGE  = "${REGISTRY}/backend:latest"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Frontend Test & Lint') {
      agent {
        kubernetes {
          yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: node
    image: node:18
    command: ["cat"]
    tty: true
"""
        }
      }
      steps {
        container('node') {
          dir('frontend') {
            catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE') {
              sh '''
#!/bin/sh
set -eu
echo "ğŸ“¦ Installing frontend deps..."
npm ci || true

echo "ğŸ” Linting..."
npm run lint || echo "âš ï¸ lint failed"

echo "ğŸ§ª Running tests..."
npm test || echo "âš ï¸ tests failed"
'''
            }
          }
        }
      }
    }

    stage('Backend Test & Lint') {
      agent {
        kubernetes {
          yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: python
    image: python:3.10
    command: ["cat"]
    tty: true
"""
        }
      }
      steps {
        container('python') {
          dir('backend') {
            catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE') {
              sh '''
#!/bin/sh
set -eu
echo "ğŸ“¦ Installing backend deps..."
pip install --no-cache-dir -r requirements.txt || true

echo "ğŸ” Running flake8..."
flake8 . || echo "âš ï¸ lint failed"

echo "ğŸ§ª Running tests..."
pytest || echo "âš ï¸ tests failed"
'''
            }
          }
        }
      }
    }

    stage('Build & Push Images') {
      agent {
        kubernetes {
          yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    tty: true
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker/
  volumes:
  - name: docker-config
    secret:
      secretName: dockerhub-secret
"""
        }
      }
      steps {
        container('kaniko') {
          sh '''
#!/bin/sh
set -eu

echo "ğŸš€ Building frontend image..."
/kaniko/executor \
  --dockerfile=frontend/Dockerfile \
  --context=dir://$(pwd)/frontend \
  --destination=$FRONTEND_IMAGE \
  --cache=true \
  --verbosity=info

echo "ğŸš€ Building backend image..."
/kaniko/executor \
  --dockerfile=backend/Dockerfile \
  --context=dir://$(pwd)/backend \
  --destination=$BACKEND_IMAGE \
  --cache=true \
  --verbosity=info

echo "âœ… Images built & pushed successfully!"
'''
          script { env.IMAGES_BUILT = 'true' }
        }
      }
    }

    stage('Deploy to Kubernetes') {
      when {
        expression { return env.IMAGES_BUILT == 'true' }
      }
      steps {
        sh '''
#!/bin/sh
set -eu
echo "ğŸš€ Deploying to Kubernetes..."
kubectl apply -f k8s/
'''
      }
    }
  }

  post {
    always {
      echo "== Pipeline finished: ${currentBuild.currentResult} =="
    }
  }
}
