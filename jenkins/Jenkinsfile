pipeline {
  agent {
    kubernetes {
      label 'kaniko'
    }
  }

  environment {
    REGISTRY = 'matt013'     // ðŸ”¹ replace with your DockerHub username
    FRONTEND_IMAGE = "${REGISTRY}/frontend:latest"
    BACKEND_IMAGE = "${REGISTRY}/backend:latest"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Frontend Test & Lint') {
      steps {
        dir('frontend') {
          container('jnlp') {   // NodeJS runs in Jenkins agent container
            sh '''
              npm ci
              npm run lint
              npm test
            '''
          }
        }
      }
    }

    stage('Backend Test & Lint') {
      steps {
        dir('backend') {
          container('jnlp') {   // Python runs in Jenkins agent container
            sh '''
              pip install -r requirements.txt
              flake8 .
              pytest
            '''
          }
        }
      }
    }

    stage('Build & Push Frontend') {
      steps {
        container('kaniko') {
          sh '''
            /kaniko/executor \
              --context=./frontend \
              --dockerfile=./frontend/Dockerfile \
              --destination=$FRONTEND_IMAGE \
              --insecure \
              --skip-tls-verify
          '''
        }
      }
    }

    stage('Build & Push Backend') {
      steps {
        container('kaniko') {
          sh '''
            /kaniko/executor \
              --context=./backend \
              --dockerfile=./backend/Dockerfile \
              --destination=$BACKEND_IMAGE \
              --insecure \
              --skip-tls-verify
          '''
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        container('jnlp') {
          sh 'kubectl apply -f k8s/'
        }
      }
    }
  }
}
